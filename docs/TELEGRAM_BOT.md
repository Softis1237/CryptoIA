## Telegram бот

Этот документ описывает устройство и запуск Telegram‑бота, который публикует прогнозы и управляет подписками.

### Архитектура
- Сервис `bot` основан на [python-telegram-bot](https://github.com/python-telegram-bot/python-telegram-bot) и работает как отдельный контейнер.
- Публикация сигналов выполняется модулем `publish_telegram.py`; он берёт готовый текст и графики из S3 и отправляет их в канал или личные сообщения.
- Подписки и права доступа хранятся в PostgreSQL; модуль `subscriptions.py` периодически отзывает истёкшие приглашения.
- Реактивные сигналы real‑time (rt_master) также публикуются через этот бот.

### Команды
Основные команды бота:
- `/start` — главное меню и первичная регистрация пользователя.
- `/buy` — открыть оплату подписки.
- `/profile` — показать статус подписки и привязку Telegram‑ID.
- `/id` — вывести ваш числовой Telegram‑ID (нужен для переменных окружения и админки).
- `/lang` — сменить язык интерфейса.
- `/help` — краткая справка.
- Партнёрские команды для админа: `/affstats`, `/affset`, `/affapprove` и др.

### Пример кнопок
Главное меню строится из inline‑кнопок:
- «Купить подписку» — выбор плана и метода оплаты (Stars/крипто).
- «Профиль» — статус, продление, ссылка на канал.
- «Партнёрка» — заявка и статистика партнёра.
- «Как это работает» и «Поддержка» — ссылки на документацию и чат поддержки.

### Переменные окружения
- `TELEGRAM_BOT_TOKEN` — токен бота из @BotFather.
- `TELEGRAM_CHAT_ID` — ID канала/чата, куда публикуются прогнозы.
- `TELEGRAM_DM_USER_IDS` — список ID пользователей для личных сообщений (через запятую).
- `TELEGRAM_RT_CHAT_ID` — (опционально) чат для real‑time сигналов.
- `TELEGRAM_PRIVATE_CHANNEL_ID` — приватный канал для платных подписчиков.
- `TELEGRAM_OWNER_ID` — ID администратора (доступ к админ‑командам).

### Развёртывание
1. Создайте бота через @BotFather и сохраните `TELEGRAM_BOT_TOKEN`.
2. При необходимости создайте канал и добавьте туда бота как администратора; узнайте `TELEGRAM_CHAT_ID`.
3. Определите ID пользователей (команда `/id`) и заполните `TELEGRAM_DM_USER_IDS` или `TELEGRAM_OWNER_ID`.
4. Заполните переменные в `.env` и запустите сервис:
   ```bash
   docker compose up -d bot
   ```
5. Нажмите `/start` в боте и отправьте тестовое сообщение:
   ```bash
   docker compose run --rm pipeline python -m pipeline.trading.publish_telegram "test"
   ```

### Типовые ошибки
- **Отсутствует токен** — бот не поднимается или отвечает `Unauthorized`. Проверьте `TELEGRAM_BOT_TOKEN` и перезапустите.
- **Неверный ID канала/пользователя** — ошибка 400 при отправке. Убедитесь, что бот добавлен в канал и пользователь нажал `/start`.
- **Старый webhook** после смены токена — очистите через `delete_webhook` (см. `docs/OPERATIONS.md`).
- **Бот не администратор канала** — публикация в канал невозможна.

