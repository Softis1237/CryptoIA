Торговый модуль и Risk‑Loop

Этот документ описывает, как формируются торговые рекомендации в CryptoIA, как настроить бумажную и живую торговлю и какие переменные окружения на это влияют. Для обзора фундаментальных свойств биткойна и базовых концепций трейдинга см. [BITCOIN_THEORY.md](BITCOIN_THEORY.md) и [TRADING_PRIMER.md](TRADING_PRIMER.md).

Алгоритм формирования сделки (trade_recommend)

Модуль pipeline/trading/trade_recommend.py получает прогнозы с горизонтами 4h/12h, вероятность роста (proba_up), диапазон доверительного интервала и ATR. Он рассчитывает оптимальные параметры сделки:

Entry zone — ценовой диапазон для открытия позиции (market или limit), рассчитывается как текущая цена ± 10–20% от ширины интервала.

Stop‑loss (SL) — уровень, где убыток фиксируется; по умолчанию устанавливается на 0,8–1 ATR от entry в сторону, противоположную предполагаемому движению.

Take‑profit (TP) — уровень фиксации прибыли; рассчитывается так, чтобы ожидаемое соотношение риск/прибыль (RR) было ≥ 2.5.

Leverage — плечо выбирается в пределах leverage_cap (по умолчанию 25). В режиме тренда коэффициент может уменьшаться.

Risk per trade — доля капитала, которую можно потерять, если SL сработает (например, 0,5–1%).

Возвращаемый объект содержит side (LONG или SHORT), entry (ценовая зона), stop_loss, take_profit, leverage и рассчитанный ожидаемый RR.

Дополнительно в стратегию интегрированы метрики баланса рынка: дисбаланс стакана,
открытый интерес, ставка финансирования и доли долгосрочных/краткосрочных
держателей. Эти показатели помогают фильтровать сигналы и корректировать
плечо и размеры позиций.

Проверка сделки (verifier)

Перед публикацией каждое предложение проходит валидацию:

Ликвидность/спред: проверяет, что текущая цена близка к entry и что диапазон interval_high - interval_low не слишком широк.

ATR‑ограничение: если интервал шире N×ATR, сделка помечается NO‑TRADE.

Противоречие новостям: если за последние 6 часов есть высокоимпактная новость противоположного настроения, сделка может быть отменена (news_conflict).

Лимит на плечо: не позволяет превышать leverage_cap.

При нарушении любого правила возвращается ok=False и reason, в Telegram будет отправлено «NO‑TRADE».

Бумажная торговля (симулятор)

Файлы trading/paper_trading.py реализуют простую биржу:

Таблица paper_accounts хранит стартовый и текущий капитал.

paper_positions — открытые позиции (side, entry, qty, sl, tp).

paper_trades — записи всех сделок (открытие, закрытие).

paper_pnl и paper_equity_curve фиксируют прибыль/убыток и кривую капитала.

Скрипт python -m pipeline.trading.paper_trading executor_once берёт последнюю рекомендацию (trades_suggestions) и открывает позицию по рынку, рассчитывая размер позиции из доли капитала (0,5% по умолчанию). Второй скрипт python -m pipeline.trading.paper_trading risk_loop опрашивает цену (CCXT_PROVIDER) раз в минуту и закрывает позиции по SL/TP. Всё происходит внутри PostgreSQL — можно анализировать результаты и оптимизировать стратегию.

Векторный бэктестер
--------------------

Для ускоренной проверки гипотез добавлен модуль `pipeline.cli.backtest`, который проигрывает исторические данные в событийной модели и симулирует работу биржи с учётом комиссий, проскальзывания и частичных исполнений. Пример запуска:

```bash
python -m pipeline.cli.backtest data/btc_1h.csv \
    --strategy pipeline.trading.backtest.strategies:MovingAverageCrossStrategy \
    --start 2022-01-01 --end 2022-12-31 --maker-fee 0.0002 --taker-fee 0.0004 --slippage 0.0005
```

Ключевые аргументы:

* `--strategy` — путь к классу стратегии в формате `module:Class`. По умолчанию используется демонстрационная стратегия пересечения скользящих.
* `--strategy-param key=value` — дополнительные параметры конструктора стратегии.
* `--report` — путь к JSON-отчёту с кривой капитала, метриками (Sharpe, Win Rate, Profit Factor, Max Drawdown) и списком сделок.
* `--maker-fee`, `--taker-fee`, `--slippage`, `--volume-limit` — параметры биржевого симулятора.

Бэктестер строит кривую капитала, считает метрики эффективности и отдаёт подробные исполнения сделок, что упрощает анализ поведения торговых агентов. В следующих итерациях планируется интеграция прямого запуска конвейера `predict_release` и агентов (например, `SMCAnalyst`) внутри симуляции.

### Переоценка позиций и отчётность

Портфель бэктестера хранит последнюю рыночную цену каждого инструмента и на каждом баре переоценивает позиции по котировке закрытия. Рыночная стоимость лонговых позиций добавляется к наличным средствам, шортовые — вычитаются, поэтому `equity` всегда равен сумме `cash` и подписанной стоимости позиций. В снапшоты и отчёт попадает фактическая стоимость портфеля, а метаданные содержат последнюю цену, нереализованную прибыль/убыток и текущую рыночную стоимость по каждому символу. Это позволяет корректно отслеживать динамику капитала даже без новых исполнений.

Живая торговля

Для реальной торговли используется trading/exchange.py, обёртка над библиотекой ccxt. Скрипт python -m pipeline.trading.executor_live берёт последнюю запись из trades_suggestions и отправляет bracket‑ордер на биржу (spot или futures):

Проверяет, что EXECUTE_LIVE=1 и заданы EXCHANGE_API_KEY/EXCHANGE_SECRET и EXCHANGE_TYPE (spot или future).

Создаёт экземпляр TradingEngine, вычисляет объём в BTC/USDT (EXEC_AMOUNT, по умолчанию 0,001).

Отправляет ордер с указанным entry_type (market или limit), SL и TP.

Записывает идентификаторы ордера в таблицу live_orders.

Включать живую торговлю следует только после длительного тестирования. Никогда не отправляйте реальные заявки без проверки (DRY_RUN по умолчанию равен 1).

Риск‑менеджмент

Два risk‑loop реализуют управление стоп‑приказами:

Live trailing (trading/risk_loop_live.py): цикл раз в RISK_LOOP_INTERVAL секунд обновляет максимум/минимум цены и вычисляет новый trailing‑stop. Формулы:

LONG: new_sl = high * (1 – RISK_TRAIL_PCT)

SHORT: new_sl = low * (1 + RISK_TRAIL_PCT)
Перемещение стопа происходит только если цена улучшилась на RISK_IMPROVE_PCT. Этот пример не содержит реализаций для изменения ордеров на бирже — вам нужно дописать взаимодействие с ccxt.

Paper risk loop (paper_trading risk_loop): опрашивает цены и закрывает позиции, когда цена достигает SL или TP.

Переменные окружения для торговли

PAPER_SYMBOL: торговая пара для симуляции (по умолчанию BTC/USDT).

EXCHANGE: провайдер ccxt (например, binance).

EXCHANGE_TYPE: spot или future.

EXCHANGE_API_KEY, EXCHANGE_SECRET, EXCHANGE_PASSWORD: ключи доступа к бирже.

EXEC_SYMBOL: торговая пара для живой торговли (BTC/USDT).

EXECUTE_LIVE: установить 1, чтобы разрешить отправку ордеров (0 — по умолчанию).

EXEC_AMOUNT: размер позиции в BTC/USDT для живого открытия (0.001).

EXEC_ENTRY: тип входа (market/limit).

DRY_RUN: если 1, ордера не отправляются на биржу.

RISK_LOOP_INTERVAL: период обновления trailing‑stop (сек). По умолчанию 60.

RISK_TRAIL_PCT: процент от максимума/минимума для trailing‑stop (0.01 = 1%).

RISK_IMPROVE_PCT: минимальное улучшение цены, чтобы перетащить стоп (0.003 = 0.3%).

При изменении этих переменных не забудьте пересобрать контейнеры или перезапустить соответствующие процессы.

## Свечные и графические паттерны

Модуль `features_patterns` анализирует исторические OHLC-данные и выделяет классические модели свечного и графического анализа:

- Doji — сигнал нерешительности рынка;
- Harami (bull/bear) — возможный разворот текущего тренда;
- Three White Soldiers — сильное бычье продолжение;
- Head & Shoulders, треугольники и флаги — фигуры, подтверждающие смену или продолжение тренда.

Для каждой модели создаётся колонка `pat_<имя>` и суммарный счёт `pat_score`, который используется при расчёте прогнозов: бычьи модели увеличивают вероятность роста, медвежьи — снижают её. Чем выше `pat_score`, тем больше доверие к сигналу и вероятность его использования в торговой логике.


Векторный бэктестер
--------------------

Для ускоренной проверки гипотез добавлен модуль `pipeline.cli.backtest`, который проигрывает исторические OHLCV‑данные в событийной манере (бар за баром) и симулирует биржу с комиссиями, проскальзыванием и частичным исполнением.

Компоненты:
- `trading/backtest/exchange_simulator.py` — обработка ордеров (market/limit/stop), maker/taker комиссии, `slippage`, ограничение объёма `volume_limit` → частичные исполнения;
- `trading/backtest/portfolio.py` — кэш, позиции и PnL;
- `trading/backtest/report.py` — equity curve и метрики (Win Rate, Profit Factor, Sharpe, max drawdown);
- `trading/backtest/runner.py` — векторный цикл проигрывания данных;
- `trading/backtest/strategies.py` — пример EMA‑стратегии и загрузка произвольной стратегии `module:Class`.

CLI пример:
```
python -m pipeline.cli.backtest data/prices.parquet \
  --symbol BTC/USDT \
  --strategy pipeline.trading.backtest.strategies:MovingAverageCrossStrategy \
  --strategy-param fast=12 --strategy-param slow=26 --strategy-param risk_fraction=0.2 \
  --slippage 0.0005 --maker-fee 0.0002 --taker-fee 0.0004 \
  --report out/backtest.json
```

Изоляция: в рамках CLI бэктестер не трогает prod‑БД. Для связанных сценариев используйте отдельный DSN.

Портфель и риск‑политики
------------------------

Модуль `trading/portfolio_manager.py` вводит единый интерфейс `PortfolioManager` (in‑memory по умолчанию; DB при `PORTFOLIO_ENABLED=1`, миграция `038_portfolio.sql`).

Интеграция с `trade_recommend` при включённом портфеле:
- добавляются поля `portfolio_decision` (open|scale_in|ignore) и `portfolio_reason`;
- при открытой противоположной позиции рекомендация становится `NO-TRADE` (reason `portfolio_block`);
- при доборе размер позиции умножается на `TR_SCALEIN_FRACTION`.

SMC‑зоны и визуализация
-----------------------

`features/features_smc.py` — детекторы зон Smart Money Concepts (OB/FVG/Liquidity/Breaker) и сохранение в БД `smc_zones` (миграция `039_smc_zones.sql`).
`reporting/charts.py:plot_price_with_smc_zones` — отрисовка зон поверх цены, артефакт `smc_zones.png` в S3.

Пост‑анализ сделок
------------------

`agents/post_mortem.py` — агент, автоматически создающий «урок» после закрытия сделки.
В бумажной торговле (`paper_trading`) запуск происходит сразу после закрытия позиции (SL/TP/horizon), в метаданные включается `run_id` исходной рекомендации (если доступен).
