Торговый модуль и Risk‑Loop

Этот документ описывает, как формируются торговые рекомендации в CryptoIA, как настроить бумажную и живую торговлю и какие переменные окружения на это влияют.

Алгоритм формирования сделки (trade_recommend)

Модуль pipeline/trading/trade_recommend.py получает прогнозы с горизонтами 4h/12h, вероятность роста (proba_up), диапазон доверительного интервала и ATR. Он рассчитывает оптимальные параметры сделки:

Entry zone — ценовой диапазон для открытия позиции (market или limit), рассчитывается как текущая цена ± 10–20% от ширины интервала.

Stop‑loss (SL) — уровень, где убыток фиксируется; по умолчанию устанавливается на 0,8–1 ATR от entry в сторону, противоположную предполагаемому движению.

Take‑profit (TP) — уровень фиксации прибыли; рассчитывается так, чтобы ожидаемое соотношение риск/прибыль (RR) было ≥ 2.5.

Leverage — плечо выбирается в пределах leverage_cap (по умолчанию 25). В режиме тренда коэффициент может уменьшаться.

Risk per trade — доля капитала, которую можно потерять, если SL сработает (например, 0,5–1%).

Возвращаемый объект содержит side (LONG или SHORT), entry (ценовая зона), stop_loss, take_profit, leverage и рассчитанный ожидаемый RR.

Проверка сделки (verifier)

Перед публикацией каждое предложение проходит валидацию:

Ликвидность/спред: проверяет, что текущая цена близка к entry и что диапазон interval_high - interval_low не слишком широк.

ATR‑ограничение: если интервал шире N×ATR, сделка помечается NO‑TRADE.

Противоречие новостям: если за последние 6 часов есть высокоимпактная новость противоположного настроения, сделка может быть отменена (news_conflict).

Лимит на плечо: не позволяет превышать leverage_cap.

При нарушении любого правила возвращается ok=False и reason, в Telegram будет отправлено «NO‑TRADE».

Бумажная торговля (симулятор)

Файлы trading/paper_trading.py реализуют простую биржу:

Таблица paper_accounts хранит стартовый и текущий капитал.

paper_positions — открытые позиции (side, entry, qty, sl, tp).

paper_trades — записи всех сделок (открытие, закрытие).

paper_pnl и paper_equity_curve фиксируют прибыль/убыток и кривую капитала.

Скрипт python -m pipeline.trading.paper_trading executor_once берёт последнюю рекомендацию (trades_suggestions) и открывает позицию по рынку, рассчитывая размер позиции из доли капитала (0,5% по умолчанию). Второй скрипт python -m pipeline.trading.paper_trading risk_loop опрашивает цену (CCXT_PROVIDER) раз в минуту и закрывает позиции по SL/TP. Всё происходит внутри PostgreSQL — можно анализировать результаты и оптимизировать стратегию.

Живая торговля

Для реальной торговли используется trading/exchange.py, обёртка над библиотекой ccxt. Скрипт python -m pipeline.trading.executor_live берёт последнюю запись из trades_suggestions и отправляет bracket‑ордер на биржу (spot или futures):

Проверяет, что EXECUTE_LIVE=1 и заданы EXCHANGE_API_KEY/EXCHANGE_SECRET и EXCHANGE_TYPE (spot или future).

Создаёт экземпляр TradingEngine, вычисляет объём в BTC/USDT (EXEC_AMOUNT, по умолчанию 0,001).

Отправляет ордер с указанным entry_type (market или limit), SL и TP.

Записывает идентификаторы ордера в таблицу live_orders.

Включать живую торговлю следует только после длительного тестирования. Никогда не отправляйте реальные заявки без проверки (DRY_RUN по умолчанию равен 1).

Риск‑менеджмент

Два risk‑loop реализуют управление стоп‑приказами:

Live trailing (trading/risk_loop_live.py): цикл раз в RISK_LOOP_INTERVAL секунд обновляет максимум/минимум цены и вычисляет новый trailing‑stop. Формулы:

LONG: new_sl = high * (1 – RISK_TRAIL_PCT)

SHORT: new_sl = low * (1 + RISK_TRAIL_PCT)
Перемещение стопа происходит только если цена улучшилась на RISK_IMPROVE_PCT. Этот пример не содержит реализаций для изменения ордеров на бирже — вам нужно дописать взаимодействие с ccxt.

Paper risk loop (paper_trading risk_loop): опрашивает цены и закрывает позиции, когда цена достигает SL или TP.

Переменные окружения для торговли

PAPER_SYMBOL: торговая пара для симуляции (по умолчанию BTC/USDT).

EXCHANGE: провайдер ccxt (например, binance).

EXCHANGE_TYPE: spot или future.

EXCHANGE_API_KEY, EXCHANGE_SECRET, EXCHANGE_PASSWORD: ключи доступа к бирже.

EXEC_SYMBOL: торговая пара для живой торговли (BTC/USDT).

EXECUTE_LIVE: установить 1, чтобы разрешить отправку ордеров (0 — по умолчанию).

EXEC_AMOUNT: размер позиции в BTC/USDT для живого открытия (0.001).

EXEC_ENTRY: тип входа (market/limit).

DRY_RUN: если 1, ордера не отправляются на биржу.

RISK_LOOP_INTERVAL: период обновления trailing‑stop (сек). По умолчанию 60.

RISK_TRAIL_PCT: процент от максимума/минимума для trailing‑stop (0.01 = 1%).

RISK_IMPROVE_PCT: минимальное улучшение цены, чтобы перетащить стоп (0.003 = 0.3%).

При изменении этих переменных не забудьте пересобрать контейнеры или перезапустить соответствующие процессы.

## Свечные и графические паттерны

Модуль `features_patterns` анализирует исторические OHLC-данные и выделяет классические модели свечного и графического анализа:

- Doji — сигнал нерешительности рынка;
- Harami (bull/bear) — возможный разворот текущего тренда;
- Three White Soldiers — сильное бычье продолжение;
- Head & Shoulders, треугольники и флаги — фигуры, подтверждающие смену или продолжение тренда.

Для каждой модели создаётся колонка `pat_<имя>` и суммарный счёт `pat_score`, который используется при расчёте прогнозов: бычьи модели увеличивают вероятность роста, медвежьи — снижают её. Чем выше `pat_score`, тем больше доверие к сигналу и вероятность его использования в торговой логике.
