CryptoIA – Многоагентная система прогнозов для BTC
CryptoIA — это комплексный стек для построения автономных утилит, которые собирают данные о крипторынке, генерируют признаки, обучают ансамбль моделей, формируют торговые рекомендации и публикуют итог в Telegram. Проект ориентирован на гибкость: большинство компонентов включаются/выключаются через переменные окружения, а модули можно перераспределять по оркестраторам (agent DAG, Windmill или простой сценарий). Ниже описана общая архитектура, запуск и основные возможности.
Структура репозитория
Основные директории расположены в services/pipeline/src/pipeline:
Модуль	Назначение
data/	Загрузка исходных данных: свечи (ingest_prices), стакан (orderbook), новости, соц‑сети, ончейн, фьючерсы и альт‑данные. Возвращают метаданные и сохраняют parquet‑файлы в S3/MinIO.
features/	Генерация признаков (технические индикаторы, стакан/он‑чейн/соц‑агрегаты, новости, контекстный scoring). Снимок фич записывается в таблицу features_snapshot.
models/	Базовые временные модели (ETS, ARIMA) плюс опциональные Darts/NeuralProphet/Prophet и ML‑бандлы.
ensemble/	Ансамблирование прогнозов и опциональный стэкинг.
regime/	Определение режима рынка: эвристика (vol, trend) + ML‑предсказатель.
similarity/	Поиск похожих исторических окон через pgvector.
scenarios/	Моделирование сценариев «если уровень — то путь» (LLM/fallback).
reasoning/	Объяснения и арбитраж аргументов (LLM/fallback); кэширование; бюджеты LLM.
trading/	Формирование торговой карты, проверка, бумажная и живая торговля, риск‑менеджмент.
reporting/	Генерация графиков и PDF‑/MD‑отчётов; публикация в Telegram.
orchestration/	Сценарии запуска (predict_release, agent_flow), планировщик.
agents/        Базовые классы и координатор агентов.
mcp/           Мини‑сервер и клиент MCP для безопасного вызова инструментов.
utils/         Общие утилиты (калибровка, текст).
infra/	База данных (Postgres + pgvector), кеш Redis, s3/minio, логи и метрики.
migrations/	SQL‑миграции для PostgreSQL (таблицы для цен, сигналов, прогнозов, торговых позиций и др.).
ops/	Инфраструктура и наблюдаемость (Prometheus, Grafana, алерты, Windmill flows). Airflow DAGи перенесены в ops/archive/airflow как опциональные.
Дополнительная документация находится в docs/ — читайте ARCHITECTURE.md для схемы потоков, DATA_SOURCES.md для источников данных, DB_SCHEMA.md для описания таблиц, ENV.md для переменных окружения, OPERATIONS.md для запуска и наблюдаемости, TRADING.md для режимов торговли, TELEGRAM_BOT.md для бота и PAYMENTS.md для оплаты подписки. В этом README собраны краткие инструкции по запуску и отладке.
Поток релиза
В стандартном сценарии pipeline запускается дважды в день (12:00 и 00:00 по Asia/Jerusalem), но можно запускать вручную. Основные шаги:
    1. Ingest: загрузка цен, новостей и (по флагам) стакана, ончейна, фьючерсов, соц‑сетей, альт‑данных. Данные сохраняются в S3 и публикуют метрики.
    2. FeaturesCalc: генерация признаков с учётом всех источников, запись snapshot.
    3. Regime & Similarity: определение режима (ML/эвристика), поиск похожих окон через pgvector.
    4. Models & Ensemble: обучение и предсказание ETS/ARIMA/ML‑моделей; ансамблирование и (опционально) стэкинг; вероятностная калибровка.
    5. Scenarios & Chart: построение сценариев с уровнями (LLM или эвристика) и генерация графика с уровнями поддержки/сопротивления.
    6. TradeRecommend & Verify: расчёт оптимальной сделки (entry, SL, TP, leverage), проверка по ограничениям (диапазон, ATR, новости) и пометка NO‑TRADE при риске.
    7. Explain & Debate: генерация краткого объяснения и арбитража аргументов. Эти шаги используют LLM, поэтому требуют ключей и настроек бюджета.
    8. Publish: формирование сообщения для Telegram (текст + график), запись всех артефактов в БД, публикация метрик.
По умолчанию система работает в двух режимах: плановый (scheduled_runner) и real‑time (trigger_agent → rt_master). Координатор DAG (agent_flow) и Windmill/ Airflow — опциональны и могут быть включены при необходимости.
Быстрый старт
    1. Склонируйте репозиторий и подготовьте окружение:
git clone https://github.com/Softis1237/CryptoIA.git
cd CryptoIA
cp .env.example .env  # заполните переменные, см. docs/ENV.md
Укажите ключи API (Dune, CryptoPanic, NewsAPI и др.), секреты S3/MinIO и параметры базы данных. По умолчанию сервис работает в таймзоне Asia/Jerusalem.
    1. Запустите инфраструктуру (Postgres + Redis + MinIO + Prometheus / Grafana) и основные сервисы:
docker compose up -d --build
Минимальный стек поднимет БД, кеш, MinIO, сервис pipeline, планировщик и пуш‑gateway. Графана доступна на http://localhost:3001 (импортируйте дашборд pipeline_overview.json из ops/grafana).
    1. Запустите релиз вручную (например, для отладки):
docker compose run --rm pipeline python -m pipeline.orchestration.predict_release --slot=manual
Или воспользуйтесь DAG: USE_COORDINATOR=1 и python -m pipeline.orchestration.agent_flow --slot=manual.
    1. Проверка здоровья: сервис поднимает HTTP эндпоинт http://localhost:8000/health. Он возвращает `OK`, если Postgres и S3 доступны; в противном случае ответит `FAIL`. Дополнительно смотрите логи контейнеров (`docker compose logs -f pipeline scheduler`) и метрики (http://localhost:9091/metrics).
    2. Режимы торговли:
    3. Бумажная торговля: включайте DRY_RUN=1 (по умолчанию) и используйте python -m pipeline.trading.paper_trading executor_once для открытия позиций. Все сделки записываются в paper_positions и связанные таблицы.
    4. Живая торговля: установите EXCHANGE_API_KEY, EXCHANGE_SECRET, EXCHANGE_TYPE и DRY_RUN=0. Скрипт python -m pipeline.trading.executor_live откроет сделку из последнего предложения. Скрипт python -m pipeline.trading.risk_loop_live следит за trailing‑stop и перемещает стоп при улучшении цены (см. docs/TRADING.md).
    5. Обучение ML моделей: для использования LGBM/XGBoost/CatBoost моделей активируйте стэкинг (ENABLE_STACKING=1) и выполняйте python -m pipeline.ops.retrain. Существует Flow ops/windmill/flows/train_ml_register.py для автоматизации.
    6. Наблюдаемость: укажите PROM_PUSHGATEWAY_URL для отправки метрик. Для мониторинга ошибок задайте SENTRY_DSN.
Переменные окружения
Список основных переменных с короткими пояснениями приведён в docs/ENV.md. Настройка правильных API‑ключей критически важна: без них компоненты (например, ончейн или фьючерсы) не будут активированы.
Расширенные возможности
    • Многоагентный режим (Agent Coordinator): активируется USE_COORDINATOR=1 и использует DAG из orchestration/agent_flow.py. Агент flow строит зависимости между ingest, models, ensemble, reasoning, сценарием и трейдом, записывает метрики и артефакты.
    • Flowise endpoints: можно подключить внешние LLM‑пайплайны для объяснения (FLOWISE_EXPLAIN_URL), дебатов (FLOWISE_DEBATE_URL), сценариев (FLOWISE_SCENARIO_URL) и валидации. При отсутствии используются встроенные эвристики и валидаторы.
    • Мини‑MCP сервер: модуль mcp/ открывает безопасные HTTP-инструменты (get_features_tail, levels_quantiles, news_top) для LLM и других клиентов.
    • Alt‑данные: модуль ingest_altdata собирает тренды Google, открытый интерес CME, опционы, данные ликвидности и RSS события. Включается флагом ENABLE_ALT_DATA=1 и требует ключей Quandl/Coinglass.
    • Регулярные retrain/feedback: скрипт pipeline.ops.feedback_metrics собирает факт результов предсказаний, рассчитывает ошибки, тэги коренных причин и пушит агрегаты в Prometheus. Его можно запускать раз в день (см. ops/windmill/flows/feedback_metrics_daily.py).
    • Многоуровневая валидация: существуют валидаторы (trade_validator, regime_validator, llm_validator), которые могут отклонять сделки или прогнозы. Они вызываются координатором, если активирован ENABLE_LLM_VALIDATOR и настроен FLOWISE_VALIDATE_URL.
Предосторожности и ограничения
Этот проект — исследовательский прототип. Он не является торговым советом и не гарантирует прибыль. Перед запуском живой торговли:
    • Тщательно протестируйте систему в режиме бумаги (DRY_RUN=1) и убедитесь, что модели устойчивы.
    • Задайте небольшие значения risk_per_trade и account_equity в trade_recommend или используйте свой менеджмент капитала.
    • Помните, что биржи имеют ограничения API и случайные разрывы соединения. Обрабатывайте исключения в своих интеграциях.
    • Всегда устанавливайте стоп‑лосс и не храните крупные суммы на торговых счетах.
При соблюдении этих правил CryptoIA может стать отличной основой для построения более сложных предиктивных и торговых систем на блокчейн‑рынке.
